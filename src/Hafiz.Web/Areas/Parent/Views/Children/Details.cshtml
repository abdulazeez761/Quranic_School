@model Hafiz.Models.Student
@using System.Security.Claims
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["ChildDetails"];
    var attendance = ViewBag.Attendance as List<Hafiz.Models.StudentAttendance> ?? new List<Hafiz.Models.StudentAttendance>();
    var paginatedWirds = ViewBag.PaginatedWirds as Hafiz.DTOs.Wird.PaginatedWirdsResponse ?? new Hafiz.DTOs.Wird.PaginatedWirdsResponse();
    var parentNotes = ViewBag.ParentNotes as IEnumerable<Hafiz.Models.ParentNote> ?? new List<Hafiz.Models.ParentNote>();
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var attendanceRate = (double)(ViewBag.AttendanceRate ?? 0);
    var presentCount = (int)(ViewBag.PresentCount ?? 0);
    var lateCount = (int)(ViewBag.LateCount ?? 0);
    var absentCount = (int)(ViewBag.AbsentCount ?? 0);
    var excusedCount = (int)(ViewBag.ExcusedCount ?? 0);
    var totalAtt = attendance.Count;
}

<div class="child-details-container">
    <!-- Header Section -->
    <div class="child-header">
        <div class="child-header-avatar">
            <i class='bx bx-user'></i>
        </div>
        <div class="child-header-info">
            <h1 class="child-name">@Model.StudentInfo.FirstName @Model.StudentInfo.SecondName</h1>
            <p class="child-username">@@Model.StudentInfo.Username</p>
            <p class="child-class">
                <i class='bx bx-book'></i>
                @(Model.Classes?.FirstOrDefault()?.Name ?? Localizer["NoClass"].ToString())
            </p>
        </div>
        <div class="header-actions">
            <a asp-area="Parent" asp-controller="Children" asp-action="Index" class="back-btn">
                <i class='bx bx-arrow-back'></i>
                @Localizer["BackToList"]
            </a>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn @(currentPage <= 1 ? "active" : "")" onclick="openTab(event, 'overview')">
                <i class='bx bx-grid-alt'></i> @Localizer["Overview"]
            </button>
            <button class="tab-btn" onclick="openTab(event, 'personal')">
                <i class='bx bx-info-circle'></i> @Localizer["PersonalInformation"]
            </button>
            <button class="tab-btn" onclick="openTab(event, 'attendance')">
                <i class='bx bx-calendar'></i> @Localizer["AttendanceHistory"]
            </button>
            <button class="tab-btn" onclick="openTab(event, 'meetings')">
                <i class='bx bx-video'></i> @Localizer["Meetings"]
            </button>
            <button class="tab-btn @(currentPage > 1 ? "active" : "")" onclick="openTab(event, 'wirds')">
                <i class='bx bx-book-bookmark'></i> @Localizer["WirdAssignments"]
            </button>
            <button class="tab-btn" onclick="openTab(event, 'notes')">
                <i class='bx bx-note'></i> @Localizer["Notes"]
                @if (parentNotes.Any())
                {
                    <span class="tab-badge">@parentNotes.Count()</span>
                }
            </button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content @(currentPage <= 1 ? "active" : "")">
            <div class="overview-cards">
                <div class="overview-card">
                    <div class="card-icon attendance-icon">
                        <i class='bx bx-calendar-check'></i>
                    </div>
                    <div class="card-content">
                        <h3>@attendanceRate%</h3>
                        <p>@Localizer["AttendanceRate"]</p>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon completion-icon">
                        <i class='bx bx-task'></i>
                    </div>
                    <div class="card-content">
                        <h3>@paginatedWirds.Wirds.Count(w => w.IsCompleted)</h3>
                        <p>@Localizer["CompletedWirds"]</p>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon juz-icon">
                        <i class='bx bx-book-open'></i>
                    </div>
                    <div class="card-content">
                        <h3>@Model.MemorizedJuz<span class="card-total">/30</span></h3>
                        <p>@Localizer["MemorizedJuz"]</p>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon tajwid-icon">
                        <i class='bx bx-star'></i>
                    </div>
                    <div class="card-content">
                        <h3>@Localizer[$"TajwidLevel_{Model.TajwidLevel}"]</h3>
                        <p>@Localizer["TajwidLevel"]</p>
                    </div>
                </div>
            </div>

            <!-- Attendance Summary Bar -->
            @if (totalAtt > 0)
            {
                <div class="section-card attendance-summary-card">
                    <div class="section-header">
                        <h2><i class='bx bx-pie-chart-alt-2'></i> @Localizer["AttendanceSummary"]</h2>
                    </div>
                    <div class="section-content">
                        <div class="attendance-bar-chart">
                            <div class="att-bar-row">
                                <span class="att-bar-label">@Localizer["AttendanceStatus_Present"]</span>
                                <div class="att-bar-track">
                                    <div class="att-bar-fill att-present" style="width: @(totalAtt > 0 ? Math.Round((double)presentCount / totalAtt * 100) : 0)%"></div>
                                </div>
                                <span class="att-bar-count">@presentCount</span>
                            </div>
                            <div class="att-bar-row">
                                <span class="att-bar-label">@Localizer["AttendanceStatus_Late"]</span>
                                <div class="att-bar-track">
                                    <div class="att-bar-fill att-late" style="width: @(totalAtt > 0 ? Math.Round((double)lateCount / totalAtt * 100) : 0)%"></div>
                                </div>
                                <span class="att-bar-count">@lateCount</span>
                            </div>
                            <div class="att-bar-row">
                                <span class="att-bar-label">@Localizer["AttendanceStatus_Absent"]</span>
                                <div class="att-bar-track">
                                    <div class="att-bar-fill att-absent" style="width: @(totalAtt > 0 ? Math.Round((double)absentCount / totalAtt * 100) : 0)%"></div>
                                </div>
                                <span class="att-bar-count">@absentCount</span>
                            </div>
                            <div class="att-bar-row">
                                <span class="att-bar-label">@Localizer["AttendanceStatus_Excused"]</span>
                                <div class="att-bar-track">
                                    <div class="att-bar-fill att-excused" style="width: @(totalAtt > 0 ? Math.Round((double)excusedCount / totalAtt * 100) : 0)%"></div>
                                </div>
                                <span class="att-bar-count">@excusedCount</span>
                            </div>
                        </div>
                        <div class="att-total-label">
                            @Localizer["TotalRecords"]: <strong>@totalAtt</strong>
                        </div>
                    </div>
                </div>
            }

            <!-- Memorization Progress -->
            <div class="section-card">
                <div class="section-header">
                    <h2><i class='bx bx-book-open'></i> @Localizer["MemorizationProgress"]</h2>
                </div>
                <div class="section-content">
                    <div class="memorization-progress">
                        <div class="progress-circle-container">
                            <div class="progress-circle" style="--progress: @(Math.Round((double)Model.MemorizedJuz / 30 * 100))">
                                <span class="progress-circle-value">@Model.MemorizedJuz/30</span>
                                <span class="progress-circle-label">@Localizer["Juz"]</span>
                            </div>
                        </div>
                        <div class="progress-details">
                            <div class="progress-detail-item">
                                <i class='bx bx-check-circle'></i>
                                <span>@Model.MemorizedJuz @Localizer["JuzMemorized"]</span>
                            </div>
                            <div class="progress-detail-item">
                                <i class='bx bx-loader-circle'></i>
                                <span>@(30 - Model.MemorizedJuz) @Localizer["JuzRemaining"]</span>
                            </div>
                            <div class="progress-detail-item">
                                <i class='bx bx-star'></i>
                                <span>@Localizer["TajwidLevel"]: @Localizer[$"TajwidLevel_{Model.TajwidLevel}"]</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Personal Info Tab -->
        <div id="personal" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h2><i class='bx bx-info-circle'></i> @Localizer["PersonalInformation"]</h2>
                </div>
                <div class="section-content">
                    <div class="info-grid">
                        <div class="info-item">
                            <label><i class='bx bx-envelope'></i> @Localizer["Email"]</label>
                            <span>@(string.IsNullOrEmpty(Model.StudentInfo.Email) ? Localizer["NotProvided"].Value : Model.StudentInfo.Email)</span>
                        </div>
                        <div class="info-item">
                            <label><i class='bx bx-phone'></i> @Localizer["PhoneNumber"]</label>
                            <span>@(string.IsNullOrEmpty(Model.StudentInfo.PhoneNumber) ? Localizer["NotProvided"].Value : Model.StudentInfo.PhoneNumber)</span>
                        </div>
                        <div class="info-item">
                            <label><i class='bx bx-calendar'></i> @Localizer["DateOfBirth"]</label>
                            <span>@Model.DateOfBirth.ToString("yyyy-MM-dd")</span>
                        </div>
                        <div class="info-item">
                            <label><i class='bx bx-user'></i> @Localizer["Gender"]</label>
                            <span>@Localizer[$"Gender_{Model.sex}"]</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h2><i class='bx bx-calendar'></i> @Localizer["AttendanceHistory"]</h2>
                    @if (totalAtt > 0)
                    {
                        <span class="header-badge badge-green">@attendanceRate% @Localizer["AttendanceRate"]</span>
                    }
                </div>
                <div class="section-content">
                    @if (attendance.Any())
                    {
                        <div class="table-responsive">
                            <table class="attendance-table">
                                <thead>
                                    <tr>
                                        <th>@Localizer["Date"]</th>
                                        <th>@Localizer["Class"]</th>
                                        <th>@Localizer["Status"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var record in attendance.OrderByDescending(a => a.Date).Take(20))
                                    {
                                        <tr>
                                            <td>
                                                <div class="date-cell">
                                                    <i class='bx bx-calendar'></i>
                                                    @record.Date.ToString("yyyy-MM-dd")
                                                </div>
                                            </td>
                                            <td>@record.Class.Name</td>
                                            <td>
                                                <span class="status-badge status-@record.Status.ToString().ToLower()">
                                                    @Localizer[$"AttendanceStatus_{record.Status}"]
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="no-data">
                            <i class='bx bx-calendar-x'></i>
                            <p>@Localizer["NoAttendanceRecords"]</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Meetings Tab -->
        <div id="meetings" class="tab-content">
            <div class="section-card meeting-section">
                <div class="section-header">
                    <h2><i class='bx bx-video'></i> @Localizer["OnlineMeetings"]</h2>
                </div>
                <div class="section-content">
                    @{
                        var childClass = Model.Classes?.FirstOrDefault();
                        if (childClass != null && childClass.IsMeetingActive)
                        {
                            <div class="meeting-alert meeting-active">
                                <div class="meeting-alert-icon">
                                    <i class='bx bx-broadcast'></i>
                                </div>
                                <div class="meeting-alert-content">
                                    <h3>@Localizer["ClassMeetingInProgress"]</h3>
                                    <p>@childClass.Name @Localizer["HasActiveMeeting"]</p>
                                    <a asp-area="Parent" asp-controller="Meeting" asp-action="Join"
                                        asp-route-classId="@childClass.Id" asp-route-studentId="@Model.UserId"
                                        class="join-meeting-btn">
                                        <i class='bx bx-video-plus'></i>
                                        @Localizer["JoinMeeting"]
                                    </a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="meeting-alert meeting-inactive">
                                <div class="meeting-alert-icon inactive">
                                    <i class='bx bx-video-off'></i>
                                </div>
                                <div class="meeting-alert-content">
                                    <h3>@Localizer["NoActiveMeeting"]</h3>
                                    <p>@Localizer["NoActiveMeetingDescription"]</p>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>

        <!-- Wirds Tab -->
        <div id="wirds" class="tab-content @(currentPage > 1 ? "active" : "")">
            <div class="section-card">
                <div class="section-header">
                    <h2><i class='bx bx-book-bookmark'></i> @Localizer["WirdAssignments"]</h2>
                </div>
                <div class="section-content">
                    @if (paginatedWirds.Wirds.Any())
                    {
                        <div class="wirds-list">
                            @foreach (var wird in paginatedWirds.Wirds)
                            {
                                <div class="wird-item @(wird.IsCompleted ? "completed" : "")">
                                    <div class="wird-header">
                                        <div class="wird-type">
                                            <i class='bx bx-file'></i>
                                            @Localizer[$"AssignmentType_{wird.Type}"]
                                        </div>
                                        <div class="wird-date">
                                            <i class='bx bx-calendar'></i>
                                            @wird.AssignedDate.ToString("yyyy-MM-dd")
                                        </div>
                                    </div>
                                    <div class="wird-content">
                                        <div class="wird-range">
                                            <span class="range-label">@Localizer["From"]:</span>
                                            <span class="range-value">
                                                @Localizer[$"Surah_{wird.FromSurah}"] (@wird.FromAyah)
                                                - @Localizer["Page"] @wird.FromPage
                                            </span>
                                        </div>
                                        <div class="wird-range">
                                            <span class="range-label">@Localizer["To"]:</span>
                                            <span class="range-value">
                                                @Localizer[$"Surah_{wird.ToSurah}"] (@wird.ToAyah)
                                                - @Localizer["Page"] @wird.ToPage
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(wird.Note))
                                        {
                                            <div class="wird-note">
                                                <i class='bx bx-note'></i>
                                                <span>@wird.Note</span>
                                            </div>
                                        }
                                    </div>
                                    <div class="wird-footer">
                                        <span class="status-badge status-@wird.Status.ToString().ToLower()">
                                            @Localizer[$"AssignmentStatus_{wird.Status}"]
                                        </span>
                                        @if (wird.IsCompleted)
                                        {
                                            <span class="completion-badge">
                                                <i class='bx bx-check-circle'></i>
                                                @Localizer["Completed"]
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Pagination Controls -->
                        <div class="pagination-controls">
                            <div class="pagination-info">
                                <span>@Localizer["Page"] @paginatedWirds.PageNumber @Localizer["Of"]
                                    @paginatedWirds.TotalPages
                                    (@paginatedWirds.TotalCount @Localizer["TotalRecords"])</span>
                            </div>
                            <div class="pagination-buttons">
                                @if (paginatedWirds.HasPreviousPage)
                                {
                                    <a asp-area="Parent" asp-controller="Children" asp-action="Details"
                                        asp-route-studentId="@Model.UserId" asp-route-page="@(paginatedWirds.PageNumber - 1)"
                                        class="pagination-btn prev-btn">
                                        <i class='bx bx-chevron-left'></i>
                                        @Localizer["Previous"]
                                    </a>
                                }
                                else
                                {
                                    <button class="pagination-btn prev-btn" disabled>
                                        <i class='bx bx-chevron-left'></i>
                                        @Localizer["Previous"]
                                    </button>
                                }

                                <div class="page-numbers">
                                    @for (int i = 1; i <= paginatedWirds.TotalPages; i++)
                                    {
                                        if (i == paginatedWirds.PageNumber)
                                        {
                                            <span class="page-num active">@i</span>
                                        }
                                        else if (i == 1 || i == paginatedWirds.TotalPages ||
                                        (i >= paginatedWirds.PageNumber - 1 && i <= paginatedWirds.PageNumber + 1))
                                        {
                                            <a asp-area="Parent" asp-controller="Children" asp-action="Details"
                                                asp-route-studentId="@Model.UserId" asp-route-page="@i" class="page-num">@i</a>
                                        }
                                        else if (i == 2 || i == paginatedWirds.TotalPages - 1)
                                        {
                                            <span class="page-num dots">...</span>
                                        }
                                    }
                                </div>

                                @if (paginatedWirds.HasNextPage)
                                {
                                    <a asp-area="Parent" asp-controller="Children" asp-action="Details"
                                        asp-route-studentId="@Model.UserId" asp-route-page="@(paginatedWirds.PageNumber + 1)"
                                        class="pagination-btn next-btn">
                                        @Localizer["Next"]
                                        <i class='bx bx-chevron-right'></i>
                                    </a>
                                }
                                else
                                {
                                    <button class="pagination-btn next-btn" disabled>
                                        @Localizer["Next"]
                                        <i class='bx bx-chevron-right'></i>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="no-data">
                            <i class='bx bx-book-alt'></i>
                            <p>@Localizer["NoWirdAssignments"]</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Notes Tab -->
        <div id="notes" class="tab-content">
            <div class="section-card">
                <div class="section-header">
                    <h2><i class='bx bx-note'></i> @Localizer["ParentNotes"]</h2>
                </div>
                <div class="section-content">
                    <!-- Notes List -->
                    @if (parentNotes.Any())
                    {
                        <div class="notes-list">
                            @foreach (var note in parentNotes.OrderByDescending(n => n.CreatedAt))
                            {
                                <div class="note-item">
                                    <div class="note-header">
                                        <div class="note-author">
                                            <i class='bx bx-user-circle'></i>
                                            <span>@note.CreatedByUser.FirstName @note.CreatedByUser.SecondName</span>
                                        </div>
                                        <div class="note-meta">
                                            <span class="note-date">
                                                <i class='bx bx-time-five'></i>
                                                @note.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                            </span>
                                        </div>
                                    </div>
                                    <div class="note-content">
                                        @note.Content
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-data no-notes-yet">
                            <i class='bx bx-notepad'></i>
                            <p>@Localizer["NoParentNotes"]</p>
                            <small>@Localizer["NoParentNotesHint"]</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        var tabContent = document.getElementsByClassName("tab-content");
        for (var i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
            tabContent[i].classList.remove("active");
        }

        var tabBtn = document.getElementsByClassName("tab-btn");
        for (var i = 0; i < tabBtn.length; i++) {
            tabBtn[i].classList.remove("active");
        }

        document.getElementById(tabName).style.display = "block";
        setTimeout(() => {
            document.getElementById(tabName).classList.add("active");
        }, 10);

        evt.currentTarget.classList.add("active");
    }

    // Character counter removed - notes are read-only
</script>
