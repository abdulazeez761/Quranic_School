@model IEnumerable<Hifz.Models.Student>
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Children"];
    var childrenStats = ViewBag.ChildrenStats as Dictionary<Guid, dynamic> ?? new Dictionary<Guid, dynamic>();
}

<link rel="stylesheet" href="~/css/parent/children-list.css" asp-append-version="true" />

<div class="children-container">
    <div class="children-header">
        <div class="header-text">
            <h1 class="page-title">
                <i class='bx bx-group'></i>
                @Localizer["MyChildren"]
            </h1>
            <p class="page-subtitle">@Localizer["ChildrenSubtitle"]</p>
        </div>
        <div class="children-count-badge">
            <i class='bx bx-user'></i>
            <span>@(Model?.Count() ?? 0) @Localizer["TotalChildren"]</span>
        </div>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="children-list">
            @foreach (var child in Model)
            {
                var childClass = child.Classes?.FirstOrDefault();
                var stats = childrenStats.ContainsKey(child.UserId) ? childrenStats[child.UserId] : null;
                bool hasMeeting = stats?.HasActiveMeeting ?? false;
                double attRate = stats?.AttendanceRate ?? 0;
                int memJuz = stats?.MemorizedJuz ?? child.MemorizedJuz;
                int compWirds = stats?.CompletedWirds ?? 0;
                int totalWirds = stats?.TotalWirds ?? 0;

                <div class="child-item @(hasMeeting ? "has-meeting" : "")">
                    @if (hasMeeting)
                    {
                        <div class="live-indicator-badge">
                            <span class="pulse-dot-sm"></span> @Localizer["LiveNow"]
                        </div>
                    }
                    <div class="child-item-avatar">
                        <i class='bx bx-user'></i>
                    </div>
                    <div class="child-item-info">
                        <h3 class="child-item-name">@child.StudentInfo.FirstName @child.StudentInfo.SecondName</h3>
                        <div class="child-item-meta">
                            <span class="meta-item">
                                <i class='bx bx-book'></i>
                                @(childClass?.Name ?? Localizer["NoClass"].ToString())
                            </span>
                            <span class="meta-item">
                                <i class='bx bx-user-circle'></i>
                                @child.StudentInfo.Username
                            </span>
                        </div>

                        <!-- Mini Progress Stats -->
                        <div class="child-progress-stats">
                            <div class="progress-stat">
                                <div class="progress-stat-header">
                                    <span class="progress-stat-label">@Localizer["AttendanceRate"]</span>
                                    <span class="progress-stat-value">@attRate%</span>
                                </div>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill fill-green" style="width: @attRate%"></div>
                                </div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-header">
                                    <span class="progress-stat-label">@Localizer["MemorizedJuz"]</span>
                                    <span class="progress-stat-value">@memJuz/30</span>
                                </div>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill fill-amber" style="width: @(Math.Round((double)memJuz / 30 * 100))%"></div>
                                </div>
                            </div>
                            <div class="progress-stat">
                                <div class="progress-stat-header">
                                    <span class="progress-stat-label">@Localizer["CompletedWirds"]</span>
                                    <span class="progress-stat-value">@compWirds/@totalWirds</span>
                                </div>
                                <div class="mini-progress-bar">
                                    <div class="mini-progress-fill fill-blue" style="width: @(totalWirds > 0 ? Math.Round((double)compWirds / totalWirds * 100) : 0)%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="child-item-actions">
                        <a asp-area="Parent" asp-controller="Children" asp-action="Details" asp-route-studentId="@child.UserId"
                            class="details-btn">
                            <i class='bx bx-show'></i>
                            @Localizer["ViewDetails"]
                        </a>
                        @if (hasMeeting && childClass != null)
                        {
                            <a asp-area="Parent" asp-controller="Meeting" asp-action="Join"
                               asp-route-classId="@childClass.Id" asp-route-studentId="@child.UserId"
                               class="meeting-btn">
                                <i class='bx bx-video'></i>
                                @Localizer["JoinMeeting"]
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-children">
            <div class="empty-illustration">
                <i class='bx bx-user-plus'></i>
            </div>
            <h3>@Localizer["NoChildren"]</h3>
            <p>@Localizer["NoChildrenDescription"]</p>
        </div>
    }
</div>
